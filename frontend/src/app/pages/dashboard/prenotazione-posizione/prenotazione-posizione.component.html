<!-- Modifico l'header per migliorare la responsività -->
<div class="max-w-7xl mx-auto p-6">
  <!-- Header con utente loggato e menu -->
  <div class="flex justify-between items-center mb-6 bg-white rounded-xl shadow-sm p-4">
    <div class="flex items-center">
      <img src="logo.png" alt="Logo" class="h-10 md:h-12">
    </div>
    <div class="flex items-center">
      <!-- Nome utente loggato -->
      <div class="user-profile mr-4">
        <div class="flex items-center">
          <div class="avatar-circle">
            <span class="initials">
              <!-- TODO: Backend - Ottenere le iniziali dell'utente loggato -->
              MB
            </span>
          </div>
          <span class="ml-2 font-medium text-gray-800 hidden sm:inline">
            <!-- TODO: Backend - Ottenere il nome dell'utente loggato -->
            Marco Bianchi
          </span>
        </div>
      </div>
      
      <!-- Pulsante menu -->
      <button class="menu-toggle" (click)="toggleUserMenu()" aria-label="Menu utente">
        <i class="fas" [class.fa-bars]="!isUserMenuOpen" [class.fa-times]="isUserMenuOpen"></i>
      </button>
    </div>
  </div>
  
  <!-- Menu a scomparsa -->
  <div class="user-menu" [class.open]="isUserMenuOpen">
    <div class="user-menu-header">
      <h3 class="text-lg font-semibold mb-2">Il tuo account</h3>
      <p class="text-sm text-gray-600 mb-4">Gestisci le tue prenotazioni</p>
    </div>
    
    <!-- Modifico la visualizzazione dello storico delle prenotazioni -->
    <div class="user-menu-section">
      <h4 class="text-md font-medium mb-3 flex items-center">
        <i class="fas fa-history mr-2 text-blue-600"></i>
        Storico prenotazioni
      </h4>
      
      <!-- TODO: Backend - Ottenere lo storico delle prenotazioni dell'utente -->
      <div *ngIf="userBookings.length === 0" class="text-gray-500 text-sm p-4 text-center">
        Non hai prenotazioni attive
      </div>
      
      <div *ngFor="let booking of userBookings" class="booking-history-item">
        <div class="booking-history-date">
          <i class="fas fa-calendar-day text-blue-500"></i>
          <span>{{ booking.date | date:'fullDate':'it-IT' }}</span>
        </div>
        <div class="booking-history-details">
          <div class="flex items-center text-sm text-gray-700">
            <i class="fas fa-map-marker-alt mr-1 text-gray-500"></i>
            <span>{{ booking.location }}</span>
          </div>
          <div class="flex items-center text-sm text-gray-700">
            <i class="fas fa-desktop mr-1 text-gray-500"></i>
            <span>{{ booking.workspace }}</span>
          </div>
          <div class="flex items-center text-sm text-gray-700">
            <i class="fas fa-clock mr-1 text-gray-500"></i>
            <span>{{ booking.time }}</span>
          </div>
          
          <!-- Visualizzazione dei dipendenti con lo stile del secondo step -->
          <div *ngIf="booking.employees && booking.employees.length > 0" class="flex flex-wrap gap-2 mt-2">
            <div *ngFor="let dipendente of booking.employees" 
                 class="flex items-center bg-blue-50 text-blue-700 px-3 py-1 rounded-full dipendente-chip">
              <i class="fas fa-user-circle mr-2"></i>
              {{ dipendente }}
            </div>
          </div>
        </div>
        <div class="booking-history-actions">
          <!-- TODO: Backend - Implementare la cancellazione della prenotazione -->
          <button class="cancel-booking-btn" (click)="cancelBooking(booking.id)">
            <i class="fas fa-times"></i> Disdici
          </button>
        </div>
      </div>
    </div>
    
    <div class="user-menu-footer">
      <!-- TODO: Backend - Implementare il logout -->
      <button class="logout-btn" (click)="logout()">
        <i class="fas fa-sign-out-alt mr-2"></i> Logout
      </button>
    </div>
  </div>
  
  <!-- Overlay per chiudere il menu quando si clicca fuori -->
  <div class="menu-overlay" [class.active]="isUserMenuOpen" (click)="closeUserMenu()"></div>
  
  <!-- Alert Messages -->
  <div class="alert" [class.show]="showAlertDate">Per favore, seleziona una data.</div>
  <div class="alert" [class.show]="showAlertLocation">Per favore, seleziona una sede.</div>
  <div class="alert" [class.show]="showAlertType">Per favore, seleziona "Cosa e Durata".</div>
  <div class="alert" [class.show]="showAlertFloor">Per favore, seleziona un piano.</div>
  <div class="alert" [class.show]="showAlertWorkspace">Per favore, seleziona una postazione.</div>
  <div class="alert" [class.show]="showAlertCancellation">Prenotazione disdetta con successo.</div>
  
  <div class="max-w-7xl mx-auto p-6">
    <!-- Step 1: Selezione Sede e Data -->
    <div *ngIf="!showStep2 && !showSummary" class="grid grid-cols-12 gap-6">
      <!-- Calendario -->
      <div class="col-span-8 bg-white rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center space-x-4">
            <h2 class="text-xl font-semibold">{{ currentMonth }}</h2>
            <div class="flex space-x-2">
              <button id="prevMonth" class="text-sm text-gray-500 hover:text-gray-900" (click)="prevMonth()">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button id="nextMonth" class="text-sm text-gray-500 hover:text-gray-900" (click)="nextMonth()">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
          
          <!-- Toggle Visualizzazione -->
          <div class="view-toggle-container">
            <span class="text-sm text-gray-700 mr-2">Calendario:</span>
            <div class="view-toggle">
              <button [class.active]="calendarView === 'month'" (click)="switchView('month')">Mensile</button>
              <button [class.active]="calendarView === 'week'" (click)="switchView('week')">Settimanale</button>
            </div>
          </div>
        </div>
  
        <!-- Vista Mensile -->
        <div *ngIf="calendarView === 'month'">
          <div class="mb-4 grid grid-cols-7 text-center text-sm text-gray-500">
            <div class="weekend-header">Dom</div>
            <div>Lun</div>
            <div>Mar</div>
            <div>Mer</div>
            <div>Gio</div>
            <div>Ven</div>
            <div class="weekend-header">Sab</div>
          </div>
  
          <div id="calendarGrid" class="calendar-grid">
            <div *ngFor="let day of calendarDays" class="calendar-day"
                [class.other-month]="day.isOtherMonth"
                [class.today]="day.isToday"
                [class.selected]="isDateSelected(day.date)"
                [class.weekend]="isWeekend(day.date)"
                [class.disabled]="isWeekend(day.date)"
                (click)="!isWeekend(day.date) && toggleDateSelection(day.date)">
              {{ day.day }}
              <div *ngIf="day.availabilityInfo && !isWeekend(day.date)" class="availability-indicator" [class]="day.availabilityClass">
                <span class="availability-dot"></span>
              </div>
              <div *ngIf="isDateSelected(day.date)" class="multi-select-indicator">{{ getSelectionIndex(day.date) }}</div>
            </div>
          </div>
        </div>
  
        <!-- Vista Settimanale -->
        <div *ngIf="calendarView === 'week'" class="weekly-view">
          <div class="week-navigation mb-4">
            <button class="week-nav-btn" (click)="prevWeek()">
              <i class="fas fa-chevron-left"></i> Precedente
            </button>
            <span class="week-date-range">{{ getWeekDateRange() }}</span>
            <button class="week-nav-btn" (click)="nextWeek()">
              Successiva <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          
          <!-- Modificare la classe min-w-[700px] con la nuova classe CSS -->
          <div class="overflow-x-auto pb-2">
            <div class="min-w-700">
              <div class="week-header">
                <div *ngFor="let day of currentWeekDays" class="week-header-cell" 
                     [class.weekend-header]="isWeekend(day)">
                  <div class="day-name">{{ getDayName(day) }}</div>
                  <div class="day-number" 
                       [class.today]="isToday(day)" 
                       [class.selected]="isDateSelected(day)"
                       [class.weekend]="isWeekend(day)">
                    {{ day.getDate() }}
                  </div>
                </div>
              </div>
              
              <div class="week-body">
                <div class="week-slots">
                  <div class="week-slot-row">
                    <div *ngFor="let day of currentWeekDays" 
                         class="week-slot-cell" 
                         [class.selected]="isDateSelected(day)"
                         [class.available]="!isWeekend(day) && calculateAvailableCount(day) > 0"
                         [class.weekend]="isWeekend(day)"
                         [class.disabled]="isWeekend(day)"
                         (click)="!isWeekend(day) && toggleDateSelection(day)">
                      <div *ngIf="!isWeekend(day) && calculateAvailableCount(day) > 0" class="availability-dot-week"></div>
                      <div *ngIf="!isWeekend(day)" class="booking-indicator">
                        {{ calculateAvailableCount(day) }} disponibili
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Dettagli Prenotazione Step 1 -->
      <div class="col-span-4">
        <div id="bookingDetailsStep1" class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">Seleziona Sede e Date</h3>
  
          <!-- Selezione Sede -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Seleziona la tua sede</label>
            <select id="selectedLocation" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    [(ngModel)]="selectedLocation" (change)="onLocationChange()">
              <option>Lecce</option>
              <option>Matera</option>
              <option>Milano Valtorta</option>
              <option>Molfetta (Casette)</option>
              <option>Molfetta (Pal. Agnelli)</option>
              <option>Molfetta (Pal. Bianca)</option>
              <option>Molfetta (Pal. Rossa)</option>
              <option>Palermo</option>
              <option>Roma (Bufalotta)</option>
              <option>Spaces Roma</option>
              <option>Trento</option>
              <option>Vicenza</option>
            </select>
          </div>
  
          <!-- Preferenze Postazioni -->
          <div class="preference-card mb-6">
            <div class="preference-card-header">
              <h4 class="preference-card-title">
                <i class="fas fa-star text-amber-400 mr-2"></i>
                Postazioni Preferite
              </h4>
              <p class="preference-card-subtitle">
                Seleziona fino a due postazioni preferite. Se la prima non è disponibile, verrà assegnata la seconda.
              </p>
            </div>
            <div class="preference-card-body">
              <div class="preference-select-modern">
                <label>
                  <span class="preference-label-number">1</span>
                  Prima scelta
                </label>
                <select
                  [(ngModel)]="preferredWorkspaces[0]"
                  (change)="updatePreferredWorkspace(0, $event)"
                  class="preference-select-input"
                >
                  <option value="">Seleziona postazione</option>
                  <option *ngFor="let workspace of getAvailableWorkspaces()" [value]="workspace.id">
                    {{ workspace.name }}
                  </option>
                </select>
              </div>
              <div class="preference-select-modern">
                <label>
                  <span class="preference-label-number">2</span>
                  Seconda scelta
                </label>
                <select
                  [(ngModel)]="preferredWorkspaces[1]"
                  (change)="updatePreferredWorkspace(1, $event)"
                  class="preference-select-input"
                >
                  <option value="">Seleziona postazione</option>
                  <option *ngFor="let workspace of getAvailableWorkspaces()" [value]="workspace.id">
                    {{ workspace.name }}
                  </option>
                </select>
              </div>
            </div>
          </div>
  
          <!-- Date Selezionate -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Date selezionate</label>
            <div *ngIf="selectedDates.length === 0" class="text-gray-500">Per favore seleziona una o più date</div>
            <div *ngIf="selectedDates.length > 0" class="selected-dates-container">
              <div *ngFor="let date of selectedDates; let i = index" class="selected-date-item">
                <span>{{ date | date:'fullDate':'it-IT' }}</span>
                <button class="remove-date-btn" (click)="removeSelectedDate(i)">×</button>
              </div>
            </div>
          </div>
  
          <!-- Disponibilità -->
          <div *ngIf="selectedDates.length > 0 && selectedLocation" class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h4 class="text-sm font-medium text-gray-700 mb-2">Disponibilità per le date selezionate</h4>
            <div class="flex items-center mb-1">
              <div class="status-dot" [ngClass]="availabilityStatus.dotClass"></div>
              <span class="text-sm">{{ availabilityStatus.text }}</span>
            </div>
            <p class="text-xs text-gray-600 mt-2">{{ availabilityStatus.description }}</p>
          </div>
  
          <button id="nextStep" class="w-full bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 transition-colors" 
                  [disabled]="selectedDates.length === 0"
                  [class.opacity-50]="selectedDates.length === 0"
                  (click)="nextStep()">
            Avanti
          </button>
        </div>
      </div>
    </div>
  
    <!-- Step 2: Dettagli Prenotazione -->
    <div *ngIf="showStep2 && !showSummary" class="grid grid-cols-12 gap-6">
      <!-- Lista Postazioni -->
      <div class="col-span-8 bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold mb-4">Seleziona Postazioni</h3>

        <div class="mb-6">
          <div id="workspaceOptions" class="space-y-2">
            <div *ngFor="let workspace of workspaceOptions" class="workspace-option"
                 [class.selected]="workspace.selected" 
                 [class.preferred]="isPreferredWorkspace(workspace.id)"
                 (click)="selectWorkspace(workspace, currentDateTab)">
              <div class="status-dot"
                   [class.available]="workspace.status === 'available'"
                   [class.reserved]="workspace.status === 'reserved'"
                   [class.occupied]="workspace.status === 'occupied'"></div>
              <span>{{ workspace.name }}</span>
              <span *ngIf="isPreferredWorkspace(workspace.id)" class="preferred-badge">
                <i class="fas fa-star"></i> Preferita
              </span>
            </div>
          </div>
        </div>

        <!-- Legenda - Modificata per essere sempre visibile -->
        <div class="flex flex-wrap justify-center gap-3 text-sm p-3 bg-gray-50 rounded-lg border border-gray-200 mt-4">
          <div class="flex items-center">
            <div class="status-dot available"></div>
            <span>Disponibile</span>
          </div>
          <div class="flex items-center">
            <div class="status-dot reserved"></div>
            <span>Riservato</span>
          </div>
          <div class="flex items-center">
            <div class="status-dot occupied"></div>
            <span>Occupato</span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-star text-amber-400 mr-1"></i>
            <span>Preferita</span>
          </div>
        </div>
      </div>

      <!-- Dettagli Step 2 -->
      <div class="col-span-4">
        <div id="bookingDetailsStep2" class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">Dettagli Prenotazione</h3>

          <!-- Tabs Date - Migliorata per essere più responsive -->
          <div class="date-tabs mb-4 overflow-x-auto pb-1">
            <div class="flex min-w-max">
              <button *ngFor="let date of selectedDates; let i = index" 
                      class="date-tab whitespace-nowrap" 
                      [class.active]="currentDateTab === i"
                      (click)="switchDateTab(i)">
                {{ date | date:'shortDate':'it-IT' }}
              </button>
            </div>
          </div>

          <!-- Resto del contenuto invariato -->
          <div class="preference-card mb-6">
            <div class="preference-card-header">
              <h4 class="preference-card-title">
                <i class="fas fa-bolt text-amber-400 mr-2"></i>
                Selezione Rapida
              </h4>
            </div>
            <div class="preference-card-body">
              <button 
                class="quick-select-btn"
                (click)="applyQuickSelection(currentDateTab)"
              >
                <i class="fas fa-bolt"></i>
                Seleziona automaticamente la prima postazione disponibile
              </button>
            </div>
          </div>

          <!-- Selezione Tipo -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Cosa e Durata</label>
            <select class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    [(ngModel)]="bookingDetails[currentDateTab].selectedType" 
                    (change)="onTypeChange(currentDateTab)">
              <option *ngFor="let type of typeOptions">{{ type }}</option>
            </select>
          </div>

         

          <!-- Trova la sezione di selezione del piano nello Step 2 e aggiungi il pulsante della planimetria -->

          <!-- Selezione Piano -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Piano</label>
            <div class="flex gap-2">
              <select class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                      [(ngModel)]="bookingDetails[currentDateTab].selectedFloor" 
                      (change)="onFloorChange(currentDateTab)">
                <option *ngFor="let floor of floorOptions">{{ floor }}</option>
              </select>
              <button 
                class="px-3 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors flex items-center"
                (click)="apriPlanimetria()"
                [disabled]="!bookingDetails[currentDateTab].selectedFloor"
                [class.opacity-50]="!bookingDetails[currentDateTab].selectedFloor"
              >
                <i class="fas fa-map-marked-alt mr-2"></i>
                <span class="hidden sm:inline">Planimetria</span>
              </button>
            </div>
          </div>

          <!-- Selezione Orario -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Orario</label>
            <select class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    [(ngModel)]="bookingDetails[currentDateTab].selectedTime">
              <option *ngFor="let time of timeOptions">{{ time }}</option>
            </select>
          </div>

          <!-- Aggiunta Dipendenti -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Aggiungi dipendenti</label>
            <div class="flex gap-2 mb-2">
              <input 
                type="text" 
                class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Inserisci nome dipendente"
                #dipendenteInput
                (keyup.enter)="addDipendente(currentDateTab, dipendenteInput.value); dipendenteInput.value=''">
              <button 
                class="px-3 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors"
                (click)="addDipendente(currentDateTab, dipendenteInput.value); dipendenteInput.value=''">
                <i class="fas fa-user-plus"></i>
              </button>
            </div>
            <div class="flex flex-wrap gap-2">
              <div *ngFor="let dipendente of bookingDetails[currentDateTab].dipendenti; let i = index" 
                   class="flex items-center bg-blue-50 text-blue-700 px-3 py-1 rounded-full animate-fade-in dipendente-chip">
                <i class="fas fa-user-circle mr-2"></i>
                {{ dipendente }}
                <button 
                  class="ml-2 text-blue-900 hover:text-blue-500 transition-colors"
                  (click)="removeDipendente(currentDateTab, i)">
                  <i class="fas fa-times text-xs"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Bottoni Navigazione -->
          <button id="nextStep" class="w-full bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 transition-colors" 
                  [disabled]="!areAllBookingsComplete()"
                  [class.opacity-50]="!areAllBookingsComplete()"
                  (click)="nextStep()">
            Avanti
          </button>
          <button id="backToDetails" class="w-full bg-gray-600 text-white rounded-lg px-4 py-2 hover:bg-gray-700 transition-colors mt-4" (click)="backToDetails()">
            Indietro
          </button>
        </div>
      </div>
    </div>
  
    <!-- Riepilogo Finale -->
    <div *ngIf="showSummary" class="grid grid-cols-12 gap-6">
      <div class="col-span-12">
        <div id="bookingSummary" class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">Riepilogo Prenotazioni</h3>
  
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Sede selezionata</label>
            <div class="text-gray-900 font-medium">{{ selectedLocation }}</div>
          </div>
  
          <!-- Postazioni Preferite -->
          <div *ngIf="hasPreferredWorkspaces()" class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h4 class="text-sm font-medium text-gray-700 mb-2">Postazioni Preferite</h4>
            <div class="flex flex-wrap gap-2">
              <ng-container *ngFor="let workspaceId of preferredWorkspaces; let idx = index">
                <div *ngIf="workspaceId" class="flex items-center bg-amber-50 text-amber-700 px-3 py-2 rounded-md">
                  <i class="fas fa-star mr-2 text-amber-500"></i>
                  {{ getWorkspaceName(workspaceId) }} {{ idx === 0 ? '(Prima scelta)' : '(Seconda scelta)' }}
                </div>
              </ng-container>
            </div>
          </div>
  
          <!-- Dettagli Prenotazioni -->
          <div *ngFor="let booking of bookingDetails; let i = index" class="booking-summary-item mb-6 p-4 bg-gray-50 rounded-lg">
            <h4 class="font-medium mb-2">Prenotazione {{ i + 1 }}: {{ selectedDates[i] | date:'fullDate':'it-IT' }}</h4>
            
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Orario</label>
                <div class="text-gray-900">{{ booking.selectedTime }}</div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cosa e Durata</label>
                <div class="text-gray-900">{{ booking.selectedType }}</div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Piano</label>
                <div class="text-gray-900">{{ booking.selectedFloor }}</div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Spazio di lavoro</label>
                <div class="text-gray-900">{{ booking.selectedWorkspace }}</div>
              </div>
  
              <!-- Dipendenti -->
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Dipendenti</label>
                <div class="flex flex-wrap gap-2">
                  <div *ngFor="let dipendente of booking.dipendenti" 
                       class="flex items-center bg-gray-100 text-gray-700 px-2 py-1 rounded-md">
                    <i class="fas fa-user-check mr-2 text-green-500"></i>
                    {{ dipendente }}
                  </div>
                </div>
              </div>
            </div>
          </div>
  
          <!-- Bottoni Conferma -->
          <button id="confirmBooking" class="w-full bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 transition-colors" (click)="confirmBooking()">
            Conferma Prenotazioni
          </button>
          <button id="backToDetails" class="w-full bg-gray-600 text-white rounded-lg px-4 py-2 hover:bg-gray-700 transition-colors mt-4" (click)="backToDetails()">
            Indietro
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Trova la sezione dove vuoi aggiungere la modale della planimetria -->
<!-- Aggiungi questo codice alla fine del file, prima della chiusura del div principale -->

<!-- Modale Planimetria -->
<app-planimetria-modale 
  *ngIf="mostraPlanimetriaModale"
  [stanzaSelezionata]="bookingDetails[currentDateTab].selectedFloor"
  [postazioniDisponibili]="getPostazioniDisponibiliPerPianoCorrente()"
  (chiudi)="chiudiPlanimetriaModale()"
  (selezionePostazione)="onSelezionePostazioneDaPlanimetria($event)">
</app-planimetria-modale>
